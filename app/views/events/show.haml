- already_registered = registered_for_event?(@event)

- if logged_in? && !already_registered
  - content_for :footer do
    %script{ id: 'stripeData', type: 'x-config/x-data', data: { key: ENV['STARFACTORY_STRIPE_KEY'], image: image_url('starfactory-avatar@64.png') } }
    %script{ id: 'eventData', type: 'x-config/x-data', data: { name: @event.workshop_name, cost: @event.cost_in_cents, email: current_user.email } }
    = javascript_include_tag 'https://checkout.stripe.com/checkout.js'
    = javascript_include_tag 'registration'

%section.textual.workshop
  %h1= @event.workshop_name
  - if logged_in? && current_user.admin?
    %nav
      = link_to 'Edit', edit_event_url(@event), class: 'btn secondary icon edit'
  = text_to_html @event.workshop_description

  %dl
    - if @event.workshop.track.present?
      %dt Track
      %dd= link_to @event.workshop_track_name, @event.workshop.track
    - if @event.instructor_profiles.any?
      %dt Instructor
      %dd
        - @event.instructor_profiles.each do |instructor|
          = link_to instructor.name, instructor
    %dt Length
    %dd= @event.smart_length

%aside.textual
  %time.big
    .monthday
      = @event.starts_at.strftime('%b %e') + ((@event.passed? || @event.registration_closed?) ? '*' : '')
    .hourspan
      = @event.starts_at.strftime '%l:%M%P'
      &mdash;
      = @event.ends_at.strftime '%l:%M%P'
  - case
  - when @event.passed?
    %br
    %h3 *Event has passed
  - when @event.registration_closed?
    %br
    %h3 *Registration closed
  - else
    = render 'shared/progress_bar', val: @event.registrations_count, max: @event.registrations_max
    - unless already_registered
      %p
        This event only has
        %strong #{pluralize (@event.spots_left), 'spot', 'spots'}
        left.
        - if logged_in? && current_user.student?
          Register now to save your spot.
    %h3
      - if already_registered
        You're registered for this workshop
      - else
        = @event.formatted_cost
    - if !logged_in?
      %p= link_to 'Register', login_url, class: 'btn', data: { confirm: "Please login to register.", buttontext: 'Login' }
    - elsif current_user.student? && !already_registered
      = form_for Registration.new do |f|
        = f.hidden_field :event_id, value: @event.id
        = f.hidden_field :student_profile_id, value: current_user.student_profile_id
        = f.hidden_field :stripe_token
        = button_tag 'Register'
    - if @event.registration_ends_at.present?
      %p
        Registration ends in
        %strong #{time_ago_in_words @event.registration_ends_at}
  - if @event.location.present?
    %address
      = link_to @event.location_google_maps_url, target: '_blank' do
        %strong= @event.location_name
        = simple_format @event.location_address
      = render 'shared/map_image', location: @event.location, size: '290x200'
  %hr
  = render 'shared/about'
